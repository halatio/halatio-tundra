swagger: "2.0"
info:
  title: halatio-tundra-api
  description: Supabase JWT secured data conversion service
  version: 3.0.0

schemes:
  - https

x-google-backend:
  address: https://halatio-tundra-440090509435.us-central1.run.app
  protocol: h2
  path_translation: APPEND_PATH_TO_ADDRESS

x-google-management:
  metrics:
    - name: request_units
      displayName: Request Units
      valueType: INT64
      metricKind: DELTA
  quota:
    limits:
      - name: request-units-per-minute
        metric: request_units
        unit: "1/min/{project}"
        values:
          STANDARD: 600

paths:
  /:
    get:
      operationId: root
      security: []
      responses:
        '200':
          description: Root response
      x-google-quota:
        metricCosts:
          request_units: 1

  /health:
    get:
      operationId: getHealth
      security: []
      responses:
        '200':
          description: Health check response
          schema:
            type: object
            properties:
              status:
                type: string
              service:
                type: string
              version:
                type: string
      x-google-quota:
        metricCosts:
          request_units: 1

  /info:
    get:
      operationId: getInfo
      security: []
      responses:
        '200':
          description: Service capabilities and limits
          schema:
            type: object
            properties:
              service:
                type: string
              version:
                type: string
              capabilities:
                type: object
              limits:
                type: object
              features:
                type: object
      x-google-quota:
        metricCosts:
          request_units: 1

  /connectors:
    get:
      operationId: getConnectors
      security:
        - supabase_jwt: []
      responses:
        '200':
          description: List available database connectors
          schema:
            type: object
            properties:
              connectors:
                type: array
                items:
                  type: string
              count:
                type: integer
        '401':
          description: Unauthorized
        '403':
          description: Forbidden
        '429':
          description: Quota exceeded at API Gateway
      x-google-quota:
        metricCosts:
          request_units: 2

  /convert/{proxy}:
    get:
      operationId: convertGetProxy
      parameters:
        - name: proxy
          in: path
          required: true
          type: string
      security:
        - supabase_jwt: []
      responses:
        '200':
          description: Proxy GET success
        '401':
          description: Unauthorized
        '403':
          description: Forbidden
        '429':
          description: Quota exceeded at API Gateway
      x-google-quota:
        metricCosts:
          request_units: 5

    post:
      operationId: convertPostProxy
      description: |
        Convert data from various sources to Parquet format.
        Supported endpoints:
        - /convert/file - Convert files (CSV, TSV, Excel, JSON, Parquet)
        - /convert/database - Extract from database using native connectors
      parameters:
        - name: proxy
          in: path
          required: true
          type: string
        - name: body
          in: body
          required: false
          schema:
            type: object
      security:
        - supabase_jwt: []
      responses:
        '200':
          description: Conversion successful
        '400':
          description: Invalid request
        '401':
          description: Unauthorized
        '403':
          description: Forbidden
        '429':
          description: Quota exceeded at API Gateway
        '500':
          description: Conversion failed
      x-google-quota:
        metricCosts:
          request_units: 10

  /test/{proxy}:
    post:
      operationId: testPostProxy
      description: |
        Test connections before saving credentials.
        Supported endpoints:
        - /test/database-connection - Test native database connectors
      parameters:
        - name: proxy
          in: path
          required: true
          type: string
        - name: body
          in: body
          required: true
          schema:
            type: object
      security:
        - supabase_jwt: []
      responses:
        '200':
          description: Connection test result
        '400':
          description: Invalid request
        '401':
          description: Unauthorized
        '403':
          description: Forbidden
        '429':
          description: Quota exceeded at API Gateway
        '500':
          description: Connection test failed
      x-google-quota:
        metricCosts:
          request_units: 6

  /infer/{proxy}:
    post:
      operationId: inferPostProxy
      description: |
        Infer schema from data sources.
        Supported endpoints:
        - /infer/schema - Infer schema from file for validation
      parameters:
        - name: proxy
          in: path
          required: true
          type: string
        - name: body
          in: body
          required: true
          schema:
            type: object
      security:
        - supabase_jwt: []
      responses:
        '200':
          description: Schema inference result
        '400':
          description: Invalid request
        '401':
          description: Unauthorized
        '403':
          description: Forbidden
        '429':
          description: Quota exceeded at API Gateway
        '500':
          description: Schema inference failed
      x-google-quota:
        metricCosts:
          request_units: 8

securityDefinitions:
  supabase_jwt:
    type: oauth2
    flow: implicit
    authorizationUrl: ""
    x-google-issuer: https://tcfdohdxjkwbvmohumex.supabase.co/auth/v1
    x-google-jwks_uri: https://tcfdohdxjkwbvmohumex.supabase.co/auth/v1/.well-known/jwks.json
